name: Deploy Terminal DinD

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  IMAGE_NAME: terminal-workspace

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull or Build Image
        run: |
          if ! docker pull ghcr.io/${{ github.actor }}/${{ env.IMAGE_NAME }}:latest 2>/dev/null; then
            cat > Dockerfile <<'EOF'
          FROM docker:24-dind
          RUN apk add --no-cache bash nodejs npm git curl wget && \
              wget -q https://github.com/tsl0922/ttyd/releases/download/1.7.4/ttyd.x86_64 -O /usr/bin/ttyd && \
              chmod +x /usr/bin/ttyd
          WORKDIR /workspace
          EXPOSE 7681 3000
          CMD ["sh", "-c", "dockerd-entrypoint.sh & sleep 5 && ttyd -p 7681 -W bash"]
          EOF
            docker build -t ghcr.io/${{ github.actor }}/${{ env.IMAGE_NAME }}:latest .
            docker push ghcr.io/${{ github.actor }}/${{ env.IMAGE_NAME }}:latest
          fi
      
      - name: Run Container
        run: |
          docker run -d --privileged \
            --name workspace \
            -p 7681:7681 \
            -p 3000:3000 \
            ghcr.io/${{ github.actor }}/${{ env.IMAGE_NAME }}:latest
      
      - name: Setup Cloudflare Tunnel
        run: |
          docker run -d --network host cloudflare/cloudflared:latest tunnel \
            --no-autoupdate run \
            --token ${{ secrets.CF_TOKEN }}
      
      - name: Wait and Auto-Save
        run: |
          echo "Terminal: term.ikhsantrx.web.id"
          echo "Panel: panel.ikhsantrx.web.id"
          sleep 19800
          
          docker commit workspace ghcr.io/${{ github.actor }}/${{ env.IMAGE_NAME }}:backup-$(date +%Y%m%d-%H%M%S)
          docker commit workspace ghcr.io/${{ github.actor }}/${{ env.IMAGE_NAME }}:latest
          docker push ghcr.io/${{ github.actor }}/${{ env.IMAGE_NAME }}:backup-$(date +%Y%m%d-%H%M%S)
          docker push ghcr.io/${{ github.actor }}/${{ env.IMAGE_NAME }}:latest
          
          echo "Backup saved!"
