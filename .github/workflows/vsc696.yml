name: Android Dev Abadi

on:
  workflow_dispatch: # Tombol Manual Start

env:
  # Ganti 'username-lu' jadi username GitHub lu (HURUF KECIL SEMUA)
  # Contoh: ghcr.io/ujang/android-dev-space:latest
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/android-dev-space:latest
  CONTAINER_NAME: vscode-runner

jobs:
  start-coding:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # IZIN PUSH IMAGE (WAJIB)

    steps:
      # 1. Login ke Gudang Image
      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 2. Cek Save Data (Load Game)
      - name: Load Save Data
        run: |
          # Cek apakah image save-an udah ada?
          if docker manifest inspect $IMAGE_NAME > /dev/null; then
            echo "‚úÖ SAVE DATA DITEMUKAN! Loading container..."
            docker pull $IMAGE_NAME
            # Run container dari save terakhir
            docker run -d \
              --name $CONTAINER_NAME \
              -p 8080:8080 \
              --privileged \
              --device /dev/kvm \
              --shm-size="2g" \
              --hostname="NetSec-God-Box" \
              -e TZ="Asia/Jakarta" \
              --device /dev/kvm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              $IMAGE_NAME
          else
            echo "üÜï SAVE DATA KOSONG. Memulai New Game..."
            # Run container baru (Code-Server Polos)
            docker run -d \
              --name $CONTAINER_NAME \
              -p 8080:8080 \
              --privileged \
              --device /dev/kvm \
              --shm-size="2g" \
              --hostname="NetSec-God-Box" \
              -e TZ="Asia/Jakarta" \
              --device /dev/kvm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -e PASSWORD=${{ secrets.VSCODE_PASS }} \
              codercom/code-server:latest
            
            # Install tools dasar (Git & Nodejs) biar gak kosongan
            echo "Install tools dasar..."
            docker exec $CONTAINER_NAME sudo apt-get update
            docker exec $CONTAINER_NAME sudo apt-get install -y git nodejs npm curl
          fi

# 3. Install & Start Cloudflare Tunnel (MANUAL MODE)
      - name: Install & Start Tunnel
        run: |
          # A. Download Binary Resmi dari Cloudflare
          echo "‚¨áÔ∏è Downloading Cloudflared..."
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

          # B. Jalanin Tunnel (Background Process)
          echo "üöá Starting Tunnel..."
          # Kita pake flag --token langsung biar ga ribet config file
          cloudflared tunnel run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }} --url http://localhost:8080 > tunnel.log 2>&1 &
          
          echo "‚úÖ Tunnel running in background!"

      # 4. MULAI SESI (Tahan 5 Jam)
      - name: ‚è≥ Sesi Aktif (5 Jam)
        continue-on-error: true
        run: |
          echo "üöÄ LINK AKSES: https://cspace.ikhsantrx.web.id"
          echo "Jangan lupa save codingan lu!"
          sleep 18000 # 5 Jam

      # 5. AUTO SAVE (Sebelum Mati)
      - name: üíæ SAVE GAME (Commit & Push)
        if: always() # Jalan terus walau timeout/cancel
        run: |
          echo "Menyimpan progress..."
          docker commit $CONTAINER_NAME $IMAGE_NAME
          docker push $IMAGE_NAME
          echo "‚úÖ Progress tersimpan di GHCR!"
